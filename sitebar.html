<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cetak Multi-Sheet PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 p-6">
    <h1 class="text-2xl font-bold mb-6">ğŸ–¨ï¸ Cetak Multi-Sheet PDF</h1>

    <div class="space-y-4 max-w-xl">
      <div>
        <label class="block font-semibold">Link Folder Drive:</label>
        <input type="text" id="folderLink" class="w-full mt-1 p-2 border rounded-md" />
      </div>

      <div>
        <label class="block font-semibold">Nama Sheet Referensi (untuk nama & nomor):</label>
        <input type="text" id="refSheet" class="w-full mt-1 p-2 border rounded-md" placeholder="Contoh: Identitas" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold">Cell Nama Siswa:</label>
          <input type="text" id="nameRefCell" class="w-full mt-1 p-2 border rounded-md" placeholder="Contoh: F1" />
        </div>
        <div>
          <label class="block font-semibold">Cell Nomor Berubah:</label>
          <input type="text" id="numberRefCell" class="w-full mt-1 p-2 border rounded-md" placeholder="Contoh: B2" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold">Nomor Awal:</label>
          <input type="number" id="start" value="1" class="w-full mt-1 p-2 border rounded-md" />
        </div>
        <div>
          <label class="block font-semibold">Nomor Akhir:</label>
          <input type="number" id="end" value="10" class="w-full mt-1 p-2 border rounded-md" />
        </div>
      </div>

     <div>
          <label class="block font-semibold">Daftar Sheet & Range:</label>
          <textarea id="sheetRanges" rows="5" class="w-full mt-1 p-2 border rounded-md" placeholder="7A - Report 1|A1:K44&#10;7A - Report 2|A1:K44"></textarea>
        </div>

      <div>
        <label class="inline-flex items-center">
          <input type="checkbox" id="merge" class="mr-2" />
          Gabung semua halaman (merge PDF)
        </label>
      </div>

      <button
        id="submitBtn"
        onclick="submitForm()"
        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center"
      >
        <span id="buttonText">ğŸ“„ Cetak PDF</span>
        <svg id="loadingSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
      </button>
    </div>

    <script>
      function submitForm() {
        const folderLink = document.getElementById("folderLink").value;
        const folderIdMatch = folderLink.match(/[-\w]{25,}/);
        if (!folderIdMatch) {
          alert("âŒ Link folder tidak valid.");
          return;
        }

        const sheetRangesRaw = document.getElementById("sheetRanges").value.trim().split('\n');
        const sheetsData = sheetRangesRaw.map(line => {
          const [sheetName, range] = line.split('|');
          return { sheetName: sheetName.trim(), range: range.trim() };
        });

        const formData = {
          folderId: folderIdMatch[0],
          nameRefSheet: document.getElementById("refSheet").value.trim(),
          nameRefCell: document.getElementById("nameRefCell").value.trim(),
          numberRefSheet: document.getElementById("refSheet").value.trim(),
          numberRefCell: document.getElementById("numberRefCell").value.trim(),
          start: document.getElementById("start").value,
          end: document.getElementById("end").value,
          sheetsData: sheetsData,
          merge: document.getElementById("merge").checked
        };

        const btn = document.getElementById("submitBtn");
        const spinner = document.getElementById("loadingSpinner");
        const btnText = document.getElementById("buttonText");

        btn.disabled = true;
        spinner.classList.remove("hidden");
        btnText.textContent = "Memproses...";

        google.script.run
          .withSuccessHandler(() => {
            alert("âœ… PDF berhasil dibuat!");
            spinner.classList.add("hidden");
            btn.disabled = false;
            btnText.textContent = "ğŸ“„ Cetak PDF";
          })
          .withFailureHandler((err) => {
            alert("âŒ Gagal membuat PDF:\n" + err.message);
            spinner.classList.add("hidden");
            btn.disabled = false;
            btnText.textContent = "ğŸ“„ Cetak PDF";
          })
          .runPDFGenerator(formData);
      }
    </script>
  </body>
</html>
